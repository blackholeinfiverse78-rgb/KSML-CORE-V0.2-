#!/usr/bin/env python3\n\"\"\"\nKSML v0.2 Final Validation Suite\n\nRuns comprehensive tests to verify v0.2 upgrade completion and stability.\n\"\"\"\n\nimport subprocess\nimport sys\nimport json\nimport time\nfrom pathlib import Path\nimport requests\n\ndef run_command(cmd, description):\n    \"\"\"Run a command and return success status\"\"\"\n    print(f\"\\nğŸ” {description}\")\n    print(f\"Command: {cmd}\")\n    \n    try:\n        result = subprocess.run(cmd, shell=True, capture_output=True, text=True, timeout=60)\n        if result.returncode == 0:\n            print(f\"âœ… SUCCESS: {description}\")\n            return True\n        else:\n            print(f\"âŒ FAILED: {description}\")\n            print(f\"Error: {result.stderr}\")\n            return False\n    except subprocess.TimeoutExpired:\n        print(f\"â° TIMEOUT: {description}\")\n        return False\n    except Exception as e:\n        print(f\"ğŸ’¥ ERROR: {description} - {e}\")\n        return False\n\ndef check_file_exists(filepath, description):\n    \"\"\"Check if a file exists\"\"\"\n    print(f\"\\nğŸ“ {description}\")\n    if Path(filepath).exists():\n        print(f\"âœ… EXISTS: {filepath}\")\n        return True\n    else:\n        print(f\"âŒ MISSING: {filepath}\")\n        return False\n\ndef validate_json_schema(schema_path, description):\n    \"\"\"Validate JSON schema file\"\"\"\n    print(f\"\\nğŸ”§ {description}\")\n    try:\n        with open(schema_path, 'r', encoding='utf-8') as f:\n            schema = json.load(f)\n        \n        # Basic schema validation\n        required_fields = ['$schema', '$id', 'title', 'type', 'properties']\n        for field in required_fields:\n            if field not in schema:\n                print(f\"âŒ INVALID: Missing {field} in {schema_path}\")\n                return False\n        \n        print(f\"âœ… VALID: {schema_path}\")\n        return True\n    except Exception as e:\n        print(f\"âŒ ERROR: {schema_path} - {e}\")\n        return False\n\ndef test_service_health():\n    \"\"\"Test validator service health\"\"\"\n    print(f\"\\nğŸ¥ Testing Service Health\")\n    try:\n        response = requests.get('http://localhost:8002/health', timeout=5)\n        if response.status_code == 200:\n            health_data = response.json()\n            print(f\"âœ… Service healthy: {health_data.get('status')}\")\n            print(f\"   Version: {health_data.get('version')}\")\n            print(f\"   Supported versions: {health_data.get('supported_versions')}\")\n            return True\n        else:\n            print(f\"âŒ Service unhealthy: HTTP {response.status_code}\")\n            return False\n    except Exception as e:\n        print(f\"âŒ Service unreachable: {e}\")\n        return False\n\ndef main():\n    \"\"\"Run complete validation suite\"\"\"\n    print(\"ğŸš€ KSML v0.2 Final Validation Suite\")\n    print(\"=\" * 50)\n    \n    results = []\n    \n    # 1. Check core deliverables exist\n    print(\"\\nğŸ“‹ PHASE 1: Core Deliverables\")\n    deliverables = [\n        (\"schema/ksml_schema_v0.1.json\", \"v0.1 Schema (preserved)\"),\n        (\"schema/ksml_schema_v0.2.json\", \"v0.2 Schema (new)\"),\n        (\"docs/v0.2_scope.md\", \"v0.2 Scope Definition\"),\n        (\"docs/versioning_rules_v0.2.md\", \"Versioning Rules v0.2\"),\n        (\"docs/safety_rules.md\", \"Safety Rules\"),\n        (\"UPGRADE_GUIDE.md\", \"Upgrade Guide\"),\n        (\"MIGRATION_NOTES.md\", \"Migration Notes\"),\n        (\"LOCK_v0.2\", \"Final Lock Document\"),\n    ]\n    \n    for filepath, description in deliverables:\n        results.append(check_file_exists(filepath, description))\n    \n    # 2. Validate schemas\n    print(\"\\nğŸ”§ PHASE 2: Schema Validation\")\n    results.append(validate_json_schema(\"schema/ksml_schema_v0.1.json\", \"v0.1 Schema Validation\"))\n    results.append(validate_json_schema(\"schema/ksml_schema_v0.2.json\", \"v0.2 Schema Validation\"))\n    \n    # 3. Run contract tests\n    print(\"\\nğŸ§ª PHASE 3: Contract Tests\")\n    test_commands = [\n        (\"cd contract_tests && python -m pytest test_contract.py -v\", \"v0.1 Backward Compatibility Tests\"),\n        (\"cd contract_tests && python -m pytest test_contract_v02.py -v\", \"v0.2 Feature Tests\"),\n        (\"cd contract_tests && python -m pytest test_failure_modes.py -v\", \"Failure Mode Tests\"),\n    ]\n    \n    for cmd, description in test_commands:\n        results.append(run_command(cmd, description))\n    \n    # 4. Test service startup and health\n    print(\"\\nğŸ¥ PHASE 4: Service Health\")\n    # Note: This assumes service is already running\n    # In production, you'd start the service here\n    results.append(test_service_health())\n    \n    # 5. Validate examples\n    print(\"\\nğŸ“ PHASE 5: Example Validation\")\n    example_commands = [\n        (\"cd validator_service && python -c \\\"import main; print('Validator imports successfully')\\\"\", \"Validator Import Test\"),\n    ]\n    \n    for cmd, description in example_commands:\n        results.append(run_command(cmd, description))\n    \n    # 6. Final summary\n    print(\"\\n\" + \"=\" * 50)\n    print(\"ğŸ“Š FINAL RESULTS\")\n    print(\"=\" * 50)\n    \n    total_tests = len(results)\n    passed_tests = sum(results)\n    failed_tests = total_tests - passed_tests\n    \n    print(f\"\\nğŸ“ˆ Test Summary:\")\n    print(f\"   Total Tests: {total_tests}\")\n    print(f\"   Passed: {passed_tests} âœ…\")\n    print(f\"   Failed: {failed_tests} âŒ\")\n    print(f\"   Success Rate: {(passed_tests/total_tests)*100:.1f}%\")\n    \n    if failed_tests == 0:\n        print(\"\\nğŸ‰ ALL TESTS PASSED - KSML v0.2 IS READY FOR PRODUCTION!\")\n        print(\"\\nğŸ”’ Status: LOCKED AND VALIDATED\")\n        print(\"ğŸš€ Ready for deployment\")\n        return 0\n    else:\n        print(f\"\\nâš ï¸  {failed_tests} TESTS FAILED - REVIEW REQUIRED\")\n        print(\"\\nğŸ”§ Action needed: Fix failing tests before production deployment\")\n        return 1\n\nif __name__ == \"__main__\":\n    exit_code = main()\n    sys.exit(exit_code)